import streamlit as st
import pandas as pd
import yfinance as yf
import requests
from datetime import datetime
import plotly.express as px

# --- CONFIGURACI√ìN ---
st.set_page_config(page_title="Statera Pro", page_icon="üõ°Ô∏è", layout="wide")

# --- ESTADO DE LA APP (Base de Datos en Sesi√≥n) ---
if 'cartera' not in st.session_state:
    st.session_state.cartera = {
        "MSCI World": 1.56, "Small Cap": 0.85, "Nasdaq-100": 0.42,
        "Shopify": 1.85, "Iren Ltd": 12.0, "Coca-Cola": 3.0, "Solana": 4.5
    }
if 'historial' not in st.session_state:
    st.session_state.historial = []

# --- BARRA LATERAL ---
with st.sidebar:
    st.title("üõ°Ô∏è Statera Settings")
    modo_privado = st.toggle("üîí Modo Privacidad", value=False)
    st.divider()
    apy_staking = st.slider("Rendimiento Staking (%)", 0.0, 15.0, 4.7)
    st.caption("Ajusta el APY seg√∫n las recompensas actuales.")

# --- OBTENCI√ìN DE DATOS ---
@st.cache_data(ttl=600)
def obtener_mercado():
    precios = {}
    tickers = {"MSCI World": "IWDA.AS", "Small Cap": "IUSN.DE", "Nasdaq-100": "SXRV.DE", "Shopify": "SHOP", "Iren Ltd": "IREN", "Coca-Cola": "KO"}
    for k, v in tickers.items():
        try: precios[k] = yf.Ticker(v).fast_info['last_price']
        except: precios[k] = 1.0
    try:
        url = "https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=eur"
        precios["Solana"] = requests.get(url).json()['solana']['eur']
    except: precios["Solana"] = 95.0
    return precios

precios = obtener_mercado()

# --- C√ÅLCULOS ---
valor_total = sum(st.session_state.cartera[k] * precios.get(k, 0) for k in st.session_state.cartera)
cosecha_diaria = (st.session_state.cartera["Solana"] * precios["Solana"] * (apy_staking/100)) / 365

# --- LAYOUT PRINCIPAL ---
t_display = "‚óè‚óè‚óè‚óè ‚Ç¨" if modo_privado else f"{valor_total:,.2f} ‚Ç¨"
st.metric("Patrimonio Total Actualizado", t_display)

tab1, tab2, tab3 = st.tabs(["üìä Dashboard", "üöÄ Inversi√≥n (Trigger)", "üìú Historial"])

with tab1:
    col_a, col_b = st.columns([1, 1])
    
    with col_a:
        st.subheader("Distribuci√≥n de Cartera")
        df_pie = pd.DataFrame({
            "Activo": st.session_state.cartera.keys(),
            "Valor": [v * precios.get(k, 0) for k, v in st.session_state.cartera.items()]
        })
        fig = px.pie(df_pie, values='Valor', names='Activo', hole=0.4, color_discrete_sequence=px.colors.qualitative.Pastel)
        st.plotly_chart(fig, use_container_width=True)

    with col_b:
        st.subheader("üåæ Generador de Pasivos")
        st.info(f"Tu staking genera aproximadamente **{cosecha_diaria:.4f} ‚Ç¨** al d√≠a.")
        st.write(f"Proyecci√≥n mensual: **{cosecha_diaria * 30:.2f} ‚Ç¨**")
        st.progress(min((cosecha_diaria * 30) / 100, 1.0), text="Progreso hacia objetivo 100‚Ç¨/mes")

with tab2:
    st.subheader("Ejecutar Trigger Quincenal")
    st.write("Se repartir√°n **63,00 ‚Ç¨** seg√∫n tu estrategia (ETF 35‚Ç¨ / Stock 18‚Ç¨ / Crypto 10‚Ç¨).")
    
    if st.button("Confirmar Inversi√≥n 63‚Ç¨"):
        reparto = {"MSCI World": 20.0, "Small Cap": 8.0, "Nasdaq-100": 7.0, "Iren Ltd": 10.0, "Coca-Cola": 8.0, "Solana": 10.0}
        for activo, monto in reparto.items():
            st.session_state.cartera[activo] += monto / precios[activo]
        
        st.session_state.historial.append({"Fecha": datetime.now().strftime("%d/%m/%Y %H:%M"), "Monto": "63.00 ‚Ç¨", "Estado": "Completado"})
        st.success("¬°Operaci√≥n ejecutada con √©xito!")

with tab3:
    st.subheader("Historial de Operaciones")
    if st.session_state.historial:
        st.table(pd.DataFrame(st.session_state.historial))
    else:
        st.write("A√∫n no hay movimientos registrados.")
